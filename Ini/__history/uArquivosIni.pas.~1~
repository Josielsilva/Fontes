unit uArquivosIni;

interface

uses System.Classes,
     Vcl.Controls,
     Vcl.ExtCtrls,
     Vcl.Dialogs,
     ZAbstractConnection,
     ZConnection,
     uArquivoIni,
     uFuncoesCryptografia,
     uDtmPrincipal,
     ZDbcIntfs,
     System.SysUtils,
     Vcl.Forms;


implementation

function Conexao : Boolean;
var vSenha : string;
begin

 if not FileExists(TArquivoIni.ArquivoIni) then
  begin
    TArquivoIni.AtualizarIni('SERVER', 'TipoDataBase', 'MSSQL');
    TArquivoIni.AtualizarIni('SERVER', 'HostName', '.\');
    TArquivoIni.AtualizarIni('SERVER', 'Port', '1433');
    TArquivoIni.AtualizarIni('SERVER', 'User', '2jt1');
    TArquivoIni.AtualizarIni('SERVER', 'Password', '2jt1@s3c');
    TArquivoIni.AtualizarIni('SERVER', 'Database', 'Dados_sys');
    MessageDlg('Arquivo '+ TArquivoIni.ArquivoIni +' Criado com sucesso' +#13+
               'Configure o arquivo antes de inicializar aplicação',MtInformation,[mbok],0);
    result:= False;
    //Application.Terminate;
  end
  else
  begin
    vSenha := DesCriptografia(TArquivoIni.LerIni('SERVER','Password'));
    if UpperCase(vSenha) <> UpperCase('@sys_sodad') then
    begin
      MessageDlg('Senha do banco de dados incorreta! ',mtInformation,[mbOK],0);
      Exit;
    end;

    DtmPrincipal:=TDtmPrincipal.Create(nil);     //Instancia o DataModule
    with DtmPrincipal.ConexaoDB do begin
       SQLHourGlass:=False;    //Habilita o Cursor em cada transação no banco de dados
      LibraryLocation:=ExtractFilePath(Application.ExeName)+'ntwdblib.dll';  //Seta a DLL para conexao do SQL
      if TArquivoIni.LerIni('SERVER','TipoDataBase')='MSSQL' then
         Protocol:='mssql';  //Protocolo do banco de dados

      HostName:= TArquivoIni.LerIni('SERVER','HostName'); //Instancia do SQLServer
      Port    := StrToInt(TArquivoIni.LerIni('SERVER','Port'));  //Porta do SQL Server
      User    := TArquivoIni.LerIni('SERVER','User');  //Usuario do Banco de Dados
      Password:= Trim(vSenha);  //Senha do Usuário do banco
      Database:= TArquivoIni.LerIni('SERVER','DataBase');;  //Nome do Banco de Dados
      AutoCommit:= True;
      TransactIsolationLevel:=tiReadCommitted;
      Connected:=True;  //Faz a Conexão do Banco
    end;
    Result := True;
  end;

// except
//  Result := false;
// end;
end;

end.
